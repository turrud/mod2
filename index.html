<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>modul3-PBO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        
        <div class="col-md-6 mb-3">
          <div class="form-floating">
            <textarea cols="auto" rows="auto" class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 100px">
                # import library xmlrpc client karena akan digunakan rpc
                import xmlrpc.client
                # buat stub/skeleton (proxy) pada client
                s = xmlrpc.client.ServerProxy('http://127.0.0.1:8008')
                # panggil fungsi pow() yang ada di komputer remote 
                print(s.pow(2,3)) # Returns 2**3 = 8
                # panggil fungsi add() yang ada di komputer remote
                print(s.add(2,3)) # Returns 5
                # panggil fungsi mul() yang ada di komputer remote
                print(s.mul(5,3)) # Returns 5*2 = 10
                # print semua fungsi yang ada di komputer remote (optional)
                print(s.system.listMethods())

            </textarea>
            <label for="floatingTextarea2">01.voting_client.py</label>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="form-floating">
            <textarea cols="auto" rows="auto" class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 100px">
                # gunakan xmlrpc bagian server
                # import SimpleXMLRPCServer dan SimpleXMLRPCRequestHandler
                from xmlrpc.server import SimpleXMLRPCServer
                from xmlrpc.server import SimpleXMLRPCRequestHandler
                # buat kelas requesthandler 
                # batasi pada path /RPC2 saja
                class RequestHandler(SimpleXMLRPCRequestHandler):
                rpc_paths = ('/RPC2',)
                # buat server serta register fungsi 
                register_introspection_functions()
                with SimpleXMLRPCServer(("127.0.0.1", 8008), requestHandler=RequestHandler) as server:
                    server.register_introspection_functions()

                # cara 1 untuk memasukkan fungsi dalam server adalah dengan langsung
                # memasukkan Namanya.
                # fungsi pow() merupakan fungsi build in pada pyhton, tinggal
                # dipanggil saja.
                server.register_function(pow)
                # cara 2 untuk register fungsi: buat fungsinya kemudian register
                # a. buat fungsi
                def adder_function(x,y):
                    return x + y
                # b. register fungsinya
                server.register_function(adder_function, 'add')
                # cara 3: tidak hanya fungsi, class juga bisa diregisterkan
                class MyFuncs:
                def mul(self, x, y):
                    return x * y
                server.register_instance(MyFuncs())
                # jalankan server
                server.serve_forever()

            </textarea>
            <label for="floatingTextarea2">01.voting_server.py</label>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="form-floating">
            <textarea cols="auto" rows="auto" class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 100px">
                # import xmlrpc bagian client saja
                import xmlrpc.client

                # buat stub (proxy) untuk client
                s = xmlrpc.client.ServerProxy('http://127.0.0.1:8008')

                # lakukan pemanggilan fungsi vote("nama_kandidat") yang ada di server
                s.vote('Made Mita')

                # lakukan pemanggilan fungsi querry() untuk mengetahui hasil persentase dari masing-masing kandidat
                hasil = s.querry()

                # lakukan pemanggilan fungsi lain terserah Anda
                for i in range(0, len(hasil[0])):
                    print(hasil[0][i], ':', hasil[1][i], ',', hasil[2][1], '%')
            </textarea>
            <label for="floatingTextarea2">02.voting_client.py</label>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="form-floating">
            <textarea cols="auto" rows="auto" class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 100px">
                # import SimpleXMLRPCServer
                from xmlrpc.server import SimpleXMLRPCServer

                # import SimpleXMLRPCRequestHandler
                from xmlrpc.server import SimpleXMLRPCRequestHandler

                import threading

                # Batasi hanya pada path /RPC2 saja supaya tidak bisa mengakses path lainnya
                class RequestHandler(SimpleXMLRPCRequestHandler):
                    rpc_paths = ('/RPC2',)

                # Buat server
                with SimpleXMLRPCServer(("127.0.0.1", 8008), requestHandler=RequestHandler) as server:

                    # buat data struktur dictionary untuk menampung nama_kandidat dan hasil voting
                    voting = {
                        "nama_kandidat": [],
                        "hasil_vote":[]
                    }
                    
                    # kode setelah ini adalah critical section, menambahkan vote tidak boeh terjadi race condition
                    # siapkan lock
                    lock = threading.Lock()
                    
                    #  buat fungsi bernama vote_candidate()
                    def vote_candidate(x):
                        
                        # critical section dimulai harus dilock
                        lock.acquire()
                        # jika kandidat ada dalam dictionary maka tambahkan  nilai votenya
                        if len(voting['nama_kandidat']) is 0:
                            voting['nama_kandidat'].append(x)
                            voting['hasil_vote'].append(1)
                        else:
                            for i in range(0, len(voting['nama_kandidat'])):
                                if voting['nama_kandidat'][i] == x:
                                    voting['hasil_vote'][i] += 1
                                break
                                if (i == len(voting['nama_kandidat'])-1):
                                    voting['nama_kandidat'].append(x)
                                    voting['hasil_vote'].append(1)

                        
                        # critical section berakhir, harus diunlock
                        lock.release()
                        return True
                    
                    # register fungsi vote_candidate() sebagai vote
                    server.register_function(vote_candidate,'vote')

                    # buat fungsi bernama querry_result
                    def querry_result():
                        # critical section dimulai
                        lock.acquire()
                        
                        # hitung total vote yang ada
                        total_vote = sum(voting['hasil_vote'])
                        
                        # hitung hasil persentase masing-masing kandidat
                        
                        
                        # critical section berakhir
                        lock.release()  
                        return [
                            voting['nama_kandidat'],
                            voting['hasil_vote'],
                            
                        ] 
                        
                    # register querry_result sebagai querry
                    server.register_function(querry_result, 'querry')


                    print ("Server voting berjalan...")
                    # Jalankan server
            </textarea>
            <label for="floatingTextarea2">02.voting_server.py</label>
          </div>
        </div>

      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>


